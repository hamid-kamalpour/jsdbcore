<!DOCTYPE HTML>
<html>
	<head>
		<title>JSDbCore - Address Book</title>
		
		<!-- Script load -->

		<script src="example-plugins/jquery.js"></script>
		<script src="jscore/JSCore.js"></script>

		<!-- some plugins of exemple dont make diference -->
		<script src="example-plugins/jui/js/jquery-ui-1.8.22.custom.min.js"></script>
		<link type="text/css" href="example-plugins/jui/css/custom-theme/jquery-ui-1.8.22.custom.css" rel="Stylesheet" />	
		<script src="example-plugins/uniform/jquery.uniform.js" type="text/javascript"></script>
		<link rel="stylesheet" href="example-plugins/uniform/css/uniform.default.css" type="text/css" media="screen" charset="utf-8" />
		<link rel="stylesheet" href="example-plugins/csstemplate/style.css" type="text/css" media="screen" charset="utf-8" />
		
		<!-- config and init JSDbCore -->
		<script>

			// default configuration object
			var defaultConfig = {
			
				// each item inside this array will create or open a database
				databases: 
				[
					{					
						name: 'address_book', // the name of the database to open or create
						
						//each item inside this array represent a store to be create or update
						stores: [
							{								
								name: 'contacts', // the store name. store are like a SQL table without a schema
								
								// an object with options
								options: {
								
									//the keyPath option sets a param to act like a SQL Primary Key. 
									//this will be better explained later
									keyPath: 'id',
									autoIncrement: true //auto increment the keyPath
								},
											
								//this array contain each index of the store. attr is the key of the store and options set some configurations
								index: [
									{ attr: 'name', options: {unique: false} },
									{ attr: 'phone', options: {unique: false}	}
								],
							}
						],
						
						//this is the version of the database.
						//the only way to update a database structure is setting his version.
						version: 4,
						
						//this callback will be executed after the database is open and ready to use
						afterOpen: function () {
							var modelContacts = JSCore.Db.Model.New({store: 'contacts', database: 'address_book'});
							modelContacts.afterFind = function (contactsFound) {
							
								for(var i in contactsFound) {
									var contact = contactsFound[i];
									addToList(contact);
								
								}
							
							};
							
							modelContacts.findAll();
			
						},
				
						//if an error ocurs this will be called. 
						errorOnOpen : function () {
							console.log('SetVersion error');
						}
					}
				]
			};
			
			var modules = [
			    {
			        name: "dbcore",
			        onLoad: function (ModuleClass) {
			                    
			            ModuleClass.init(defaultConfig);
			        
			        }
			    },
			    {
			    	name: "mvccore",
					onLoad: function (ModuleClass) {
						if(JSCore.Db) {
							ModuleClass.init();						
						}
					}
			    }
			];			

			JSCore.loadModules({ modules: modules });
				
			// Exemple functions
			function addToList (obj) {

				var container = '<li class="' + obj.key + '"><div class="contact">' +
					'<p>Nome: ' + obj.attributes.name + '</p>' +
					'<p>Phone: ' + obj.attributes.phone + '</p>' +
					'<button class="delete" id="' + obj.key + '">Delete</button>' +
					'</div></li>';

				$('.listContacts').append(container);	
			
			}
			
			function clearList () {
			
				$('.listContacts li').remove();
			
			}
			
			$(document).on('click', '.delete', function () {
			
				var key = $(this).attr('id');
				$('.' + key).remove();
				
				var modelContacts = JSCore.Db.Model.New({store: 'contacts', database: 'address_book'});
				
				modelContacts.key = key;
				modelContacts.delete();
				
			});
			
			$(document).on('change', '#iSearch', function () {
				clearList();
				var value = $(this).val();
				var modelContacts = JSCore.Db.Model.New({store: 'contacts', database: 'address_book'});
				
				modelContacts.afterFind = function (contactsFound) {

					for(var i in contactsFound) {
						var contact = contactsFound[i];
						addToList(contact);
					
					}
				
				};
				
				//add a find criteria
				modelContacts.dbcriteria.addSearch({name: value, phone: value});

				//modelContacts.dbcriteria.obrigatory = true;
				modelContacts.findAllByCriteria();			
			
			});
			
			$(document).on('click', '.actionAdd', function () {
			
				var inputName = $('#name').val();
				$('#name').val('');
				var inputPhone = $('#phone').val();
				$('#phone').val('');
				var modelContacts = JSCore.Db.Model.New({store: 'contacts', database: 'address_book'});
				
				modelContacts.attributes = {
					name: inputName,
					phone: inputPhone
				};
				
				modelContacts.afterSave = function () {
	
					addToList(modelContacts);
				
				}
				
				modelContacts.save();
				
			
			});
			
			$(document).ready(function () {
				
				$("select, input, button").uniform();
			
			});
		
		</script>
	</head>
	<body>
		<div id="app-title">
		</div>
		<div id="app-content">
			<div class="header">
				<center><p><h1>AddressBook using JSDbCore</h1></p>
				<div class="hr"></div></center>
			</div>
			<div class="content">
				<div class="controls">
					<label for="iSearch">Search </label><input type="text" id="iSearch" style="width: 100%;" />
					<div class="addnew" style="margin-top: 40px;">
						<h3>Add new Contact</h3>
						<div class="hr"></div>
						<p><label for="name">Name </label><input type="text" id="name" style="width: 100%;" /></p>
						<p><label for="phone">Phone </label><input type="text" id="phone" style="width: 100%;"/></p>
						<p><button class="actionAdd">Add</button></p>
					</div>
				</div>
				<h3 style="margin-top: 40px;">Contacts</h3>
					<div class="hr"></div>
				<div class="containerContacts">
					<ul class="listContacts">
					</ul>
				</div>
			</div>
		</div>	
		<div id="app-footer">
		</div>	
	</body>
</html>
